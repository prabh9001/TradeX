<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade X</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">



    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- TradingView Core -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/mew.jpg') }}" type="image/x-icon">

    <!-- Chart.js for Backtesting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <!-- HEADER -->
    <header>
        <div class="header-content">
            <a href="/"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.75rem;">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-chart-simple"></i>
                    </div>
                    <span>Trade X</span>
                </div>
            </a>

            <nav>
                <ul class="nav-links">
                    <li><a href="#" class="nav-link active" onclick="showView('dashboard')">Dashboard</a></li>
                    <li><a href="#" class="nav-link" onclick="showView('portfolio')">Portfolio</a></li>
                    <li><a href="#" class="nav-link" onclick="showView('screener')">Screener</a></li>
                    <li><a href="#" class="nav-link" onclick="showView('backtest')">Backtest</a></li>
                </ul>
            </nav>

            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <div class="market-status" id="marketStatusContainer">
                    <div class="status-dot" id="marketStatusDot"></div>
                    <span id="marketStatusText">MARKET LOADING...</span>
                </div>
                <button onclick="toggleTheme()" id="themeSwitcher" class="nav-link"
                    style="background: var(--bg-glass); border: 1px solid var(--border-color); border-radius: var(--radius-full); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-primary);">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <a href="/logout" class="nav-link"
                    style="color: var(--accent-danger); display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <!-- MARKET INDICES BAR -->
    <div class="indices-bar">
        <div class="indices-container" id="indicesTicker">
            <div class="index-item loading">Loading market indices...</div>
        </div>
    </div>

    <!-- SEARCH SECTION -->
    <div class="search-section" id="globalSearch">
        <div class="search-container">
            <div class="search-wrapper">
                <input type="text" id="tickerInput" class="search-input"
                    placeholder="Enter Stock Symbol (e.g., RELIANCE, TCS, NIFTY 50)"
                    onkeydown="if(event.key === 'Enter') analyzeStock()" autocomplete="off"
                    style="text-transform: uppercase;">
            </div>
            <button class="btn btn-primary" onclick="analyzeStock()" id="analyzeBtn">
                <i class="fas fa-brain"></i>
                ANALYZE
            </button>
        </div>

        <div id="globalLoader" class="loader" style="display: none;"></div>
        <div id="globalLoadingText"
            style="text-align: center; display: none; margin-top: 1rem; color: var(--accent-primary); font-weight: 600;">
            <i class="fas fa-spinner fa-spin"></i> AI Processing Market Data...
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="main-container" id="mainDashboard" style="opacity: 0; transition: opacity 0.5s;">

        <!-- Stock Header -->
        <div class="glass-card col-span-12" id="stockHeader"
            style="margin-bottom: 1.5rem; position: relative; overflow: hidden;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;">
                <div>
                    <h1 style="font-size: 2rem; font-weight: 900; margin-bottom: 0rem; line-height: 1;"
                        id="stockTicker">---</h1>
                    <div id="stockName"
                        style="color: var(--accent-primary); font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">
                        ---</div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;" id="stockInfo">Select a stock to begin
                        analysis</p>
                </div>
                <div
                    style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                    <div id="livePrice" style="font-size: 2.2rem; font-weight: 900; color: var(--text-primary);">
                        â‚¹0.00</div>
                    <button class="btn btn-primary" onclick="openPortfolioModal()"
                        style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                        <i class="fas fa-plus-circle"></i> ADD TO PORTFOLIO
                    </button>
                    <div id="header-price-widget" style="width: 350px; height: 60px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- GRID LAYOUT -->
        <div class="dashboard-grid">

            <!-- AI PREDICTION PANEL -->
            <div class="glass-card col-span-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-robot"></i> AI Prediction</h3>
                </div>

                <div class="prediction-display">
                    <div class="prediction-icon" id="predictionIcon">ðŸ¤–</div>
                    <div class="prediction-text" id="predictionText">---</div>
                    <p class="card-subtitle">Next 24H Forecast</p>

                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceBar" style="width: 0%;"></div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                        Confidence: <span id="confidenceText" style="font-weight: 700;">0%</span>
                    </p>

                    <div class="signal-badge hold" id="signalBadge">HOLD</div>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;"
                        id="signalStrength">---</p>
                </div>
            </div>
            <div class="glass-card col-span-8" id="chartCard"
                style="min-height: 550px; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
                <div class="card-header" style="padding: 1.5rem 1.5rem 1rem 1.5rem; margin-bottom: 0;">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Live Chart</h3>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button onclick="toggleFullscreen()"
                            style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; transition: color 0.3s;"
                            onmouseover="this.style.color='var(--accent-primary)'"
                            onmouseout="this.style.color='var(--text-secondary)'">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <div id="tv_chart_container" style="flex: 1; width: 100%; position: relative;">
                    <!-- Widget will be injected here -->
                </div>
            </div>



            <!-- TECHNICAL INDICATORS -->
            <div class="glass-card col-span-6">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-bar"></i> Technical Indicators</h3>
                </div>

                <div class="indicators-grid">
                    <div class="indicator-item">
                        <div class="indicator-name">RSI (14)</div>
                        <div class="indicator-value" id="rsi">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-name">MACD</div>
                        <div class="indicator-value" id="macd">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-name">Stochastic</div>
                        <div class="indicator-value" id="stoch">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-name">ATR</div>
                        <div class="indicator-value" id="atr">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-name">BB Width</div>
                        <div class="indicator-value" id="bbWidth">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-name">Volume Ratio</div>
                        <div class="indicator-value" id="volRatio">--</div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary);">Support</span>
                        <span style="font-weight: 700; color: var(--accent-success);" id="support">$0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Resistance</span>
                        <span style="font-weight: 700; color: var(--accent-danger);" id="resistance">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- SENTIMENT & RISK -->
            <div class="glass-card col-span-6">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-newspaper"></i> Sentiment & Risk</h3>
                </div>

                <!-- Sentiment -->
                <div
                    style="text-align: center; padding: 1rem; background: var(--bg-glass); border-radius: var(--radius-md); margin-bottom: 1rem;">
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">NEWS SENTIMENT
                    </p>
                    <div style="font-size: 2rem; font-weight: 900;" id="sentimentLabel">NEUTRAL</div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Score: <span
                            id="sentimentScore">0.00</span></p>
                </div>

                <!-- Risk Metrics -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div
                        style="background: var(--bg-glass); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.5rem;">VOLATILITY
                        </p>
                        <p style="font-size: 1.5rem; font-weight: 800; color: var(--accent-warning);" id="volatility">
                            --%</p>
                    </div>
                    <div
                        style="background: var(--bg-glass); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.5rem;">SHARPE RATIO
                        </p>
                        <p style="font-size: 1.5rem; font-weight: 800; color: var(--accent-info);" id="sharpe">--</p>
                    </div>
                    <div
                        style="background: var(--bg-glass); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.5rem;">MAX DRAWDOWN
                        </p>
                        <p style="font-size: 1.5rem; font-weight: 800; color: var(--accent-danger);" id="maxDrawdown">
                            --%</p>
                    </div>
                    <div
                        style="background: var(--bg-glass); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.5rem;">VAR (95%)
                        </p>
                        <p style="font-size: 1.5rem; font-weight: 800; color: var(--accent-primary);" id="var95">--%</p>
                    </div>
                </div>
            </div>



            <!-- NEWS FEED -->
            <div class="glass-card col-span-12">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-rss"></i> Latest News & Analysis</h3>
                </div>
                <div id="newsFeed" style="display: grid; gap: 1rem;">
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No news available</p>
                </div>
            </div>

        </div>
    </div>

    <!-- SCREENER VIEW -->
    <div class="main-container" id="screenerView" style="display: none; opacity: 1;">
        <div class="glass-card col-span-12" style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem;"><i class="fas fa-filter"></i>
                        Option Chain Screener</h1>
                    <p style="color: var(--text-secondary);">Live NSE Option Chain Data & Insights</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <select id="optionSymbol" class="search-input" style="width: 150px; padding: 0.5rem;">
                        <option value="NIFTY">NIFTY 50</option>
                        <option value="BANKNIFTY">BANK NIFTY</option>
                        <option value="FINNIFTY">FIN NIFTY</option>
                        <option value="SENSEX">SENSEX</option>
                    </select>
                    <select id="optionExpiry" class="search-input" style="width: 150px; padding: 0.5rem;"
                        onchange="fetchOptionChain()">
                        <option value="">Nearest Expiry</option>
                    </select>
                    <button class="btn btn-primary" onclick="fetchOptionChain()">
                        <i class="fas fa-sync"></i> REFRESH
                    </button>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- UPSTOX OPTION INSIGHTS -->
            <div class="glass-card col-span-12" id="optionInsightsCard" style="display: none; margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-project-diagram"></i> Greeks & Sentiment Insights - <span
                            id="optIndexName">NIFTY</span></h3>
                    <div style="font-size: 0.8rem; color: var(--accent-primary);">
                        PCR: <span id="upstoxPcr">--</span> |
                        Expiry: <span id="upstoxExpiry">--</span> |
                        Spot: <span id="underlyingValue">--</span>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; text-align: center;">
                        <thead>
                            <tr
                                style="color: var(--text-secondary); border-bottom: 2px solid var(--border-color); font-size: 0.85rem;">
                                <th style="padding: 1rem; border-right: 1px solid var(--border-color);">CE GREEKS (Î” / Î˜
                                    / Î“ / Î½)</th>
                                <th style="padding: 1rem; width: 120px;">STRIKE</th>
                                <th style="padding: 1rem; border-left: 1px solid var(--border-color);">PE GREEKS (Î” / Î˜
                                    / Î“ / Î½)</th>
                            </tr>
                        </thead>
                        <tbody id="upstoxGreeksBody">
                            <tr>
                                <td colspan="3" style="padding: 3rem; color: var(--text-secondary);">
                                    <i class="fas fa-spinner fa-spin"></i> Loading Greeks...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- OPTION OI CHART -->
            <div class="glass-card col-span-12" id="optionChartCard" style="display: none; margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-bar"></i> Open Interest (OI) Distribution</h3>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        <span style="color: rgba(16, 185, 129, 0.8);">â– </span> CALL OI
                        <span style="color: rgba(239, 68, 68, 0.8); margin-left: 10px;">â– </span> PUT OI
                    </div>
                </div>
                <div style="height: 350px; width: 100%; padding: 1.5rem; position: relative;">
                    <canvas id="oiChart"></canvas>
                </div>
            </div>

            <!-- FULL OPTION CHAIN TABLE -->
            <div class="glass-card col-span-12" id="fullChainCard">
                <div class="card-header" style="flex-wrap: wrap; gap: 10px; justify-content: space-between;">
                    <h3 class="card-title"><i class="fas fa-list-ol"></i> <span id="fullChainTitle">Full Option
                            Chain</span></h3>
                    <div id="movementStats" style="display: flex; gap: 15px; font-size: 0.85rem;">
                        <span style="color: var(--accent-success); font-weight: 700;">
                            MOST MOV: <span id="mostActiveStrike"
                                style="background: rgba(16, 185, 129, 0.1); padding: 2px 8px; border-radius: 4px;">--</span>
                        </span>
                        <span style="color: var(--accent-danger); font-weight: 700;">
                            LEAST MOV: <span id="leastActiveStrike"
                                style="background: rgba(239, 68, 68, 0.1); padding: 2px 8px; border-radius: 4px;">--</span>
                        </span>
                    </div>
                </div>
                <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85rem;">
                        <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 10;">
                            <tr style="color: var(--text-secondary); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 0.75rem; background: rgba(239, 68, 68, 0.05);">CE Movement</th>
                                <th
                                    style="padding: 0.75rem; background: rgba(239, 68, 68, 0.08); color: var(--text-primary); font-weight: 800; border-left: 1px solid var(--border-color);">
                                    CE OI
                                </th>
                                <th style="padding: 0.75rem; background: rgba(239, 68, 68, 0.05);">CE Price</th>
                                <th style="padding: 0.75rem; width: 100px; background: var(--bg-glass);">STRIKE</th>
                                <th style="padding: 0.75rem; width: 100px; background: var(--bg-glass);">DATE</th>
                                <th style="padding: 0.75rem; background: rgba(16, 185, 129, 0.05);">PE Price</th>
                                <th
                                    style="padding: 0.75rem; background: rgba(16, 185, 129, 0.08); color: var(--text-primary); font-weight: 800; border-right: 1px solid var(--border-color);">
                                    PE OI
                                </th>
                                <th style="padding: 0.75rem; background: rgba(16, 185, 129, 0.05);">PE Movement</th>
                            </tr>
                        </thead>
                        <tbody id="fullChainBody">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
                <div id="optError"
                    style="display: none; padding: 2rem; text-align: center; color: var(--accent-danger);"></div>
            </div>
        </div>
    </div>
    <!-- PORTFOLIO VIEW -->
    <div class="main-container" id="portfolioView" style="display: none; opacity: 1;">
        <div class="glass-card col-span-12" style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem;"><i class="fas fa-wallet"></i>
                        My Portfolio</h1>
                    <p style="color: var(--text-secondary);">Track your holdings and performance</p>
                </div>
                <div id="portfolioSummary" style="display: flex; gap: 2rem;">
                    <div class="text-right">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase;">Total
                            Invested</div>
                        <div id="portInvested" style="font-size: 1.25rem; font-weight: 800;">â‚¹0.00</div>
                    </div>
                    <div class="text-right">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase;">
                            Current Value</div>
                        <div id="portValue" style="font-size: 1.25rem; font-weight: 800;">â‚¹0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs" style="margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
            <button class="tab active" id="tabHoldings" onclick="switchPortfolioTab('Holding')">Holdings <span
                    id="countHoldings">(0)</span></button>
            <button class="tab" id="tabPositions" onclick="switchPortfolioTab('Position')">Positions <span
                    id="countPositions">(0)</span></button>
        </div>

        <div class="glass-card col-span-12">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr
                            style="border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem;">
                            <th style="padding: 1rem;">STOCK</th>
                            <th style="padding: 1rem;">QUANTITY</th>
                            <th style="padding: 1rem;">AVG. PRICE</th>
                            <th style="padding: 1rem;">CURR. PRICE</th>
                            <th style="padding: 1rem;">INVESTED VALUE</th>
                            <th style="padding: 1rem; text-align: center;">ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                        <!-- Portfolios items will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ADD TO PORTFOLIO MODAL -->
    <div id="portfolioModal" class="glass-card"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 400px; padding: 2rem; border: 2px solid var(--accent-primary);">
        <h3 class="card-title" style="margin-bottom: 1.5rem;">Add <span id="modalTicker">---</span> to Portfolio</h3>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.3rem;">Product
                    Type</label>
                <select id="portType" class="search-input" style="padding: 0.75rem; width: 100%;">
                    <option value="Holding">Holding (Long Term)</option>
                    <option value="Position">Position (Intraday)</option>
                </select>
            </div>
            <div>
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.3rem;">Quantity</label>
                <input type="number" id="portQty" class="search-input" value="1" min="1" style="padding: 0.75rem;">
            </div>
            <div>
                <label
                    style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.3rem;">Buy
                    Price (Avg)</label>
                <input type="number" id="portPrice" class="search-input" style="padding: 0.75rem;">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-primary" style="flex: 1;" onclick="addToPortfolio()">SECURE HOLDING</button>
                <button class="btn" style="flex: 1; background: var(--bg-glass); color: var(--text-primary);"
                    onclick="closePortfolioModal()">CANCEL</button>
            </div>
        </div>
    </div>
    <div id="modalOverlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1050;"
        onclick="closePortfolioModal()"></div>

    <div id="btLoader" class="loader" style="display: none;"></div>
    <div id="btLoadingText" style="display: none;"></div>
    <!-- BACKTEST VIEW -->
    <div class="main-container" id="backtestView" style="display: none; opacity: 1;">
        <div class="glass-card col-span-12" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h1 style="font-size: 2rem; font-weight: 900;"><i class="fas fa-microscope"></i> Strategy Backtester
                    </h1>
                    <p style="color: var(--text-secondary);">Validate your edge using years of historical market data
                    </p>
                </div>
            </div>

            <!-- Parameters Grid -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; background: var(--bg-glass); padding: 1.5rem; border-radius: var(--radius-lg);">
                <div>
                    <label
                        style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Select
                        Stock/Index</label>
                    <input type="text" id="btTicker" class="search-input" placeholder="e.g. RELIANCE"
                        style="padding: 0.75rem; width: 100%;">
                </div>
                <div>
                    <label
                        style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Strategy</label>
                    <select id="btStrategy" class="search-input" style="padding: 0.75rem; width: 100%;">
                        <option value="EMA_CROSS">EMA Crossover (20/50)</option>
                        <option value="MEAN_REVERSION">Mean Reversion (BB)</option>
                        <option value="RSI_STRATEGY">RSI Momentum (30/70)</option>
                        <option value="MACD_CROSS">MACD Trend Crossover</option>
                        <option value="SUPERTREND">SuperTrend Pro</option>
                    </select>
                </div>
                <div>
                    <label
                        style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Start
                        Date</label>
                    <input type="date" id="btStart" class="search-input" value="2023-01-01"
                        style="padding: 0.75rem; width: 100%;">
                </div>
                <div>
                    <label
                        style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Initial
                        Capital (â‚¹)</label>
                    <input type="number" id="btCapital" class="search-input" value="100000"
                        style="padding: 0.75rem; width: 100%;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" style="width: 100%; padding: 0.85rem;" onclick="runBacktest()">
                        <i class="fas fa-play-circle"></i> RUN BACKTEST
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Content (Hidden until Run) -->
        <div id="btResults" style="display: none;">
            <div class="dashboard-grid" style="margin-bottom: 2rem;">
                <div class="glass-card col-span-3 text-center">
                    <p style="color: var(--text-secondary); font-size: 0.8rem;">TOTAL RETURN</p>
                    <h2 id="btRoi" style="font-size: 1.8rem; font-weight: 800;">--%</h2>
                </div>
                <div class="glass-card col-span-3 text-center">
                    <p style="color: var(--text-secondary); font-size: 0.8rem;">WIN RATE</p>
                    <h2 id="btWinRate" style="font-size: 1.8rem; font-weight: 800;">--%</h2>
                </div>
                <div class="glass-card col-span-3 text-center">
                    <p style="color: var(--text-secondary); font-size: 0.8rem;">SHARPE RATIO</p>
                    <h2 id="btSharpe" style="font-size: 1.8rem; font-weight: 800;">--</h2>
                </div>
                <div class="glass-card col-span-3 text-center">
                    <p style="color: var(--text-secondary); font-size: 0.8rem;">MAX DRAWDOWN</p>
                    <h2 id="btDrawdown" style="font-size: 1.8rem; font-weight: 800; color: var(--accent-danger);">--%
                    </h2>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Equity Curve Chart -->
                <div class="glass-card col-span-8">
                    <div class="card-header">
                        <h3 class="card-title">Equity Growth Curve</h3>
                    </div>
                    <div style="height: 400px; padding: 1rem;">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>

                <!-- Trade List -->
                <div class="glass-card col-span-4">
                    <div class="card-header">
                        <h3 class="card-title">Trade History</h3>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                <tr style="border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                                    <th style="padding: 0.75rem; text-align: left;">Date</th>
                                    <th style="padding: 0.75rem;">Type</th>
                                    <th style="padding: 0.75rem;">Price</th>
                                    <th style="padding: 0.75rem; text-align: right;">P&L</th>
                                </tr>
                            </thead>
                            <tbody id="btTradeTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        let currentTicker = '';
        let currentTimeframe = 'D';
        let currentData = null;

        function loadChart(symbol, period = 'D') {
            // 1. Clean the symbol (BSE/NSE as appropriate)
            let cleanSymbol = symbol.toUpperCase();

            // Map common indices to their TradingView equivalents
            if (cleanSymbol === 'NIFTY' || cleanSymbol === '^NSEI') {
                cleanSymbol = "NSE:NIFTY";
            } else if (cleanSymbol === 'BANKNIFTY' || cleanSymbol === '^NSEBANK') {
                cleanSymbol = "NSE:BANKNIFTY";
            } else if (cleanSymbol === 'SENSEX' || cleanSymbol === '^BSESN') {
                cleanSymbol = "BSE:SENSEX";
            } else if (cleanSymbol === 'FINNIFTY') {
                cleanSymbol = "NSE:FINNIFTY";
            } else if (!cleanSymbol.includes(":")) {
                cleanSymbol = "BSE:" + cleanSymbol;
            }

            // Map timeframe
            let tvInterval = "D"; // Reverted to Day
            if (period === '1min') tvInterval = '1';
            else if (period === '5min') tvInterval = '5';
            else if (period === '1W') tvInterval = 'W';
            else if (period === '1M') tvInterval = '60';
            else if (period === '1Y') tvInterval = 'D';
            else if (period === 'D') tvInterval = 'D';

            // --- PART A: LOAD THE MAIN BIG CHART ---
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';

            new TradingView.widget({
                "autosize": true,
                "symbol": cleanSymbol,
                "interval": tvInterval,
                "timezone": "Asia/Kolkata",
                "theme": currentTheme, // Use current theme
                "style": "1",
                "locale": "in",
                "toolbar_bg": currentTheme === 'dark' ? "#131722" : "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "withdateranges": true,
                "hide_side_toolbar": false,
                "details": true,
                "hotlist": true,
                "calendar": true,
                "container_id": "tv_chart_container"
            });

            // --- PART B: HEADER PRICE SYNC ---
            startLivePriceTracking(cleanSymbol);
        }

        let priceTrackerInterval = null;
        function startLivePriceTracking(ticker) {
            if (priceTrackerInterval) clearInterval(priceTrackerInterval);

            // Clean symbol for yf API search in background
            let yfTicker = ticker;
            if (ticker.includes(':')) yfTicker = ticker.split(':')[1] + ".BO";

            priceTrackerInterval = setInterval(function () {
                if (!currentTicker) return;
                fetch(`/api/get-latest-price/${yfTicker}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.price > 0) {
                            const priceEl = document.getElementById('livePrice');
                            const oldPrice = parseFloat(priceEl.textContent.replace(/[â‚¹$]/g, ''));

                            priceEl.textContent = (ticker.includes('BSE') || ticker.includes('NSE') ? 'â‚¹' : '$') + data.price.toFixed(2);

                            // Add flash effect
                            if (data.price > oldPrice) {
                                priceEl.style.color = 'var(--accent-success)';
                            } else if (data.price < oldPrice) {
                                priceEl.style.color = 'var(--accent-danger)';
                            }

                            setTimeout(() => {
                                priceEl.style.color = 'var(--text-primary)';
                            }, 500);
                        }
                    })
                    .catch(err => console.error("Price fetch error:", err));
            }, 2000); // 2 seconds as requested for rapid updates
        }

        function toggleFullscreen() {
            const chartCard = document.getElementById('chartCard');
            if (!document.fullscreenElement) {
                if (chartCard.requestFullscreen) {
                    chartCard.requestFullscreen();
                } else if (chartCard.webkitRequestFullscreen) {
                    chartCard.webkitRequestFullscreen();
                } else if (chartCard.msRequestFullscreen) {
                    chartCard.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        async function analyzeStock(timeframe = null) {
            const inputEl = document.getElementById('tickerInput');
            let ticker = inputEl.value.trim().toUpperCase() || currentTicker;

            if (!ticker) {
                inputEl.style.borderColor = 'var(--accent-danger)';
                setTimeout(() => inputEl.style.borderColor = '', 2000);
                return;
            }

            // Clean common prefixes
            ticker = ticker.replace(/^(NSE:|BSE:)/i, '');

            if (timeframe) currentTimeframe = timeframe;
            currentTicker = ticker;
            inputEl.value = ticker; // Sync UI

            // Update Chart
            loadChart(ticker, currentTimeframe);

            // Show loading
            if (document.getElementById('globalLoader')) document.getElementById('globalLoader').style.display = 'block';
            if (document.getElementById('globalLoadingText')) document.getElementById('globalLoadingText').style.display = 'block';
            document.getElementById('mainDashboard').style.opacity = '0.3';

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticker: ticker,
                        timeframe: currentTimeframe
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentData = result.data;
                    updateDashboard(result.data);

                    // Reveal dashboard
                    document.getElementById('mainDashboard').style.opacity = '1';
                } else {
                    alert('Error: ' + result.error);
                }

            } catch (error) {
                console.error('Analysis error:', error);
                alert('Analysis Error: ' + (error.message || 'Unknown error'));
            } finally {
                if (document.getElementById('globalLoader')) document.getElementById('globalLoader').style.display = 'none';
                if (document.getElementById('globalLoadingText')) document.getElementById('globalLoadingText').style.display = 'none';
            }
        }

        function updateDashboard(data) {
            if (!data) return;
            try {
                // Determine currency symbol based on ticker
                const tickerStr = data.ticker || '';
                const indianIndicators = ['.NS', '.BO', 'NIFTY', 'BANKNIFTY', '^NSEI', '^NSEBANK', 'NSE_INDEX'];
                const isIndianStock = indianIndicators.some(indicator => tickerStr.includes(indicator)) ||
                    (!tickerStr.includes('.') && tickerStr.length <= 10 && !['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA'].includes(tickerStr));
                const currencySymbol = isIndianStock ? 'â‚¹' : '$';

                // Stock Header
                if (document.getElementById('stockTicker')) document.getElementById('stockTicker').textContent = tickerStr;
                if (document.getElementById('stockName')) document.getElementById('stockName').textContent = data.stock_name || tickerStr;
                if (document.getElementById('stockInfo')) document.getElementById('stockInfo').textContent = `${data.trend || 'Neutral'} Trend â€¢ Accuracy: ${data.accuracy || 50}%`;

                // Initialize Live Price immediately
                if (document.getElementById('livePrice') && data.current_price) {
                    document.getElementById('livePrice').textContent = currencySymbol + data.current_price.toFixed(2);
                }

                // Prediction (Consensus)
                if (document.getElementById('predictionText')) {
                    const predText = document.getElementById('predictionText');
                    predText.textContent = data.prediction || '---';
                    predText.className = 'prediction-text ' + (data.prediction === 'BULLISH' ? 'up' : 'down');
                }

                if (document.getElementById('predictionIcon')) document.getElementById('predictionIcon').textContent = data.prediction === 'BULLISH' ? 'ðŸ“ˆ' : 'ðŸ“‰';
                if (document.getElementById('confidenceBar')) document.getElementById('confidenceBar').style.width = (data.confidence || 0) + '%';
                if (document.getElementById('confidenceText')) document.getElementById('confidenceText').textContent = (data.confidence || 0) + '%';

                // Signal
                if (document.getElementById('signalBadge')) {
                    const signalEl = document.getElementById('signalBadge');
                    signalEl.textContent = data.signal || 'HOLD';
                    signalEl.className = 'signal-badge ' + (data.signal || 'HOLD').toLowerCase();
                }
                if (document.getElementById('signalStrength')) document.getElementById('signalStrength').textContent = (data.signal_strength || '---') + ' Signal';

                // Indicators
                if (data.indicators) {
                    if (document.getElementById('rsi')) document.getElementById('rsi').textContent = data.indicators.RSI || '--';
                    if (document.getElementById('macd')) document.getElementById('macd').textContent = data.indicators.MACD || '--';
                    if (document.getElementById('stoch')) document.getElementById('stoch').textContent = data.indicators.Stoch_K || '--';
                    if (document.getElementById('atr')) document.getElementById('atr').textContent = data.indicators.ATR || '--';
                    if (document.getElementById('bbWidth')) document.getElementById('bbWidth').textContent = data.indicators.BB_Width || '--';
                    if (document.getElementById('volRatio')) document.getElementById('volRatio').textContent = data.indicators.Volume_Ratio || '--';
                }

                // Support/Resistance
                if (document.getElementById('support')) document.getElementById('support').textContent = `${currencySymbol}${data.support || 0}`;
                if (document.getElementById('resistance')) document.getElementById('resistance').textContent = `${currencySymbol}${data.resistance || 0}`;

                // Sentiment
                if (document.getElementById('sentimentLabel')) {
                    const sentimentEl = document.getElementById('sentimentLabel');
                    sentimentEl.textContent = data.sentiment || 'Neutral';
                    sentimentEl.style.color = data.sentiment === 'Bullish' ? 'var(--accent-success)' :
                        (data.sentiment === 'Bearish' ? 'var(--accent-danger)' : 'var(--text-secondary)');
                }
                if (document.getElementById('sentimentScore')) document.getElementById('sentimentScore').textContent = data.sentiment_score || 0;

                // Risk Metrics
                if (data.risk_metrics) {
                    if (document.getElementById('volatility')) document.getElementById('volatility').textContent = (data.risk_metrics.volatility || 0) + '%';
                    if (document.getElementById('sharpe')) document.getElementById('sharpe').textContent = data.risk_metrics.sharpe_ratio || 0;
                    if (document.getElementById('maxDrawdown')) document.getElementById('maxDrawdown').textContent = (data.risk_metrics.max_drawdown || 0) + '%';
                    if (document.getElementById('var95')) document.getElementById('var95').textContent = (data.risk_metrics.var_95 || 0) + '%';
                }

                // News Feed
                renderNews(data.news);

                // --- NEW: Greeks for Main Dashboard (If Index) ---
                const dashboardGreeks = data.option_chain_upstox;
                const greeksContainerId = 'dashboardGreeksContainer';
                let greeksContainer = document.getElementById(greeksContainerId);

                if (dashboardGreeks && dashboardGreeks.items && dashboardGreeks.items.length > 0) {
                    if (!greeksContainer) {
                        // Create it before news feed if it doesn't exist
                        const newsEl = document.querySelector('#newsFeed').parentElement;
                        greeksContainer = document.createElement('div');
                        greeksContainer.id = greeksContainerId;
                        greeksContainer.className = 'glass-card col-span-12';
                        greeksContainer.style.marginBottom = '1.5rem';
                        newsEl.parentNode.insertBefore(greeksContainer, newsEl);
                    }

                    greeksContainer.style.display = 'block';
                    greeksContainer.innerHTML = `
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-project-diagram"></i> Option Greeks Insights - ${data.ticker}</h3>
                            <div style="font-size: 0.8rem; color: var(--accent-primary);">PCR: ${dashboardGreeks.pcr} | Expiry: ${dashboardGreeks.expiry}</div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse; text-align: center;">
                                <thead>
                                    <tr style="color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">
                                        <th style="padding: 0.5rem;">CE Greeks (D/T/G/V)</th>
                                        <th style="padding: 0.5rem;">Strike</th>
                                        <th style="padding: 0.5rem;">PE Greeks (D/T/G/V)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dashboardGreeks.items.map(item => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 0.5rem; color: var(--accent-success); font-family: monospace;">
                                                ${item.ce_delta.toFixed(2)}/${item.ce_theta.toFixed(2)}/${item.ce_gamma.toFixed(3)}/${item.ce_vega.toFixed(2)}
                                            </td>
                                            <td style="padding: 0.5rem; font-weight: 700; background: rgba(255,255,255,0.03);">${item.strike}</td>
                                            <td style="padding: 0.5rem; color: var(--accent-danger); font-family: monospace;">
                                                ${item.pe_delta.toFixed(2)}/${item.pe_theta.toFixed(2)}/${item.pe_gamma.toFixed(3)}/${item.pe_vega.toFixed(2)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (greeksContainer) {
                    greeksContainer.style.display = 'none';
                }


            } catch (e) {
                console.error('Update Error:', e);
                throw e; // Re-throw to be caught by analyzeStock
            }
        }





        function renderNews(newsArray) {
            const container = document.getElementById('newsFeed');

            if (!newsArray || newsArray.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No news available</p>';
                return;
            }

            container.innerHTML = newsArray.map(item => `
                <a href="${item.link}" target="_blank" style="text-decoration: none; display: block;">
                    <div class="news-item" style="background: var(--bg-glass); padding: 1rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.transform='translateX(5px)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <h4 style="margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.95rem; line-height: 1.4;">${item.title}</h4>
                                <p style="color: var(--text-secondary); font-size: 0.75rem;"><i class="far fa-clock"></i> ${item.date || 'Recent'}</p>
                            </div>
                            <span style="padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 700; 
                                         background: ${item.sentiment === 'Positive' ? 'rgba(16,185,129,0.1)' : (item.sentiment === 'Negative' ? 'rgba(239,68,68,0.1)' : 'rgba(156,163,175,0.1)')};
                                         color: ${item.sentiment === 'Positive' ? 'var(--accent-success)' : (item.sentiment === 'Negative' ? 'var(--accent-danger)' : 'var(--text-secondary)')};">
                                ${item.sentiment}
                            </span>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        function changeTimeframe(period) {
            currentTimeframe = period;

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('onclick').includes(`'${period}'`)) {
                    tab.classList.add('active');
                }
            });

            // Re-analyze with new timeframe
            if (currentTicker) {
                analyzeStock(period);
            }
        }

        // Global interval for option chain auto-refresh
        let optionChainAutoRefresh = null;

        function showView(viewName) {
            // Clear existing auto-refresh
            if (optionChainAutoRefresh) {
                clearInterval(optionChainAutoRefresh);
                optionChainAutoRefresh = null;
            }

            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${viewName}'`)) {
                    link.classList.add('active');
                }
            });

            // Toggle views
            if (viewName === 'dashboard') {
                document.getElementById('globalSearch').style.display = 'block';
                document.getElementById('mainDashboard').style.display = 'block';
                document.getElementById('screenerView').style.display = 'none';
                document.getElementById('portfolioView').style.display = 'none';
                document.getElementById('backtestView').style.display = 'none';
                setTimeout(() => document.getElementById('mainDashboard').style.opacity = '1', 50);
            } else if (viewName === 'screener') {
                document.getElementById('globalSearch').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('screenerView').style.display = 'block';
                document.getElementById('portfolioView').style.display = 'none';
                document.getElementById('backtestView').style.display = 'none';
                fetchOptionChain();
                // Set auto-refresh every 30 seconds for live Excel sync
                optionChainAutoRefresh = setInterval(fetchOptionChain, 30000);
            } else if (viewName === 'portfolio') {
                document.getElementById('globalSearch').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('screenerView').style.display = 'none';
                document.getElementById('portfolioView').style.display = 'block';
                document.getElementById('backtestView').style.display = 'none';
                fetchPortfolio();
            } else if (viewName === 'backtest') {
                document.getElementById('globalSearch').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('screenerView').style.display = 'none';
                document.getElementById('portfolioView').style.display = 'none';
                document.getElementById('backtestView').style.display = 'block';
            } else {
                alert(viewName.toUpperCase() + " module is coming soon in the next update!");
            }
        }

        // --- BACKTEST LOGIC ---
        let btEquityChart = null;

        async function runBacktest() {
            const data = {
                ticker: document.getElementById('btTicker').value.trim().toUpperCase() || 'NIFTY',
                strategy: document.getElementById('btStrategy').value,
                start_date: document.getElementById('btStart').value,
                initial_capital: parseFloat(document.getElementById('btCapital').value) || 100000
            };

            const btn = document.querySelector('button[onclick="runBacktest()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SIMULATING...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('btResults').style.display = 'block';

                    // Render Metrics
                    const m = result.metrics;
                    const roiEl = document.getElementById('btRoi');
                    roiEl.textContent = (m.roi >= 0 ? '+' : '') + m.roi + '%';
                    roiEl.style.color = m.roi >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)';

                    document.getElementById('btWinRate').textContent = m.win_rate + '%';
                    document.getElementById('btSharpe').textContent = m.sharpe;
                    document.getElementById('btDrawdown').textContent = m.max_drawdown + '%';

                    // Render Table
                    const table = document.getElementById('btTradeTable');
                    table.innerHTML = result.trades.length > 0 ? result.trades.map(t => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                            <td style="padding: 0.6rem;">${t.date}</td>
                            <td style="padding: 0.6rem;"><span style="color: ${t.type === 'BUY' ? 'var(--accent-success)' : 'var(--accent-primary)'}; font-weight: 700;">${t.type}</span></td>
                            <td style="padding: 0.6rem;">â‚¹${t.price}</td>
                            <td style="padding: 0.6rem; text-align: right; color: ${t.profit >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">${t.profit !== undefined ? 'â‚¹' + t.profit.toLocaleString() : '-'}</td>
                        </tr>
                    `).join('') : '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-muted);">No trades executed during this period.</td></tr>';

                    // Render Chart
                    renderEquityChart(result.equity_curve);
                } else {
                    alert('Backtest error: ' + result.error);
                }
            } catch (e) {
                console.error('Backtest failed:', e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function renderEquityChart(curve) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (btEquityChart) btEquityChart.destroy();

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

            btEquityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: curve.map(c => c.date),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: curve.map(c => c.value),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: {
                            grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                            ticks: { color: 'var(--text-secondary)' }
                        }
                    }
                }
            });
        }

        // --- PORTFOLIO LOGIC ---
        let portfolioData = [];
        let currentPortfolioTab = 'Holding';

        function switchPortfolioTab(tab) {
            currentPortfolioTab = tab;
            document.getElementById('tabHoldings').classList.toggle('active', tab === 'Holding');
            document.getElementById('tabPositions').classList.toggle('active', tab === 'Position');
            renderPortfolio();
        }

        function openPortfolioModal() {
            const ticker = document.getElementById('stockTicker').textContent;
            if (ticker === '---') {
                alert('Please analyze a stock first');
                return;
            }
            document.getElementById('modalTicker').textContent = ticker;

            // Try to pre-fill price
            const lp = document.getElementById('livePrice').textContent.replace(/[â‚¹$]/g, '');
            document.getElementById('portPrice').value = lp;

            document.getElementById('portfolioModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function closePortfolioModal() {
            document.getElementById('portfolioModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }

        async function addToPortfolio() {
            const ticker = document.getElementById('modalTicker').textContent;
            const quantity = document.getElementById('portQty').value;
            const avg_price = document.getElementById('portPrice').value;
            const type = document.getElementById('portType').value;

            try {
                const response = await fetch('/api/portfolio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, quantity, avg_price, type })
                });
                const result = await response.json();
                if (result.success) {
                    alert(`${ticker} added to ${type} successfully!`);
                    closePortfolioModal();
                    fetchPortfolio();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                console.error('Portfolio save error:', e);
            }
        }

        async function fetchPortfolio() {
            const body = document.getElementById('portfolioBody');
            body.innerHTML = '<tr><td colspan="6" style="padding: 3rem; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Loading Portfolio...</td></tr>';

            try {
                const response = await fetch('/api/portfolio');
                const result = await response.json();

                if (result.success) {
                    portfolioData = result.portfolio.holdings;

                    // Update Summary
                    document.getElementById('portInvested').textContent = 'â‚¹' + result.portfolio.total_invested.toLocaleString();
                    document.getElementById('portValue').textContent = 'â‚¹' + result.portfolio.total_value.toLocaleString();

                    // Update Tab Counts
                    const hCount = portfolioData.filter(x => x.type === 'Holding').length;
                    const pCount = portfolioData.filter(x => x.type === 'Position').length;
                    document.getElementById('countHoldings').textContent = `(${hCount})`;
                    document.getElementById('countPositions').textContent = `(${pCount})`;

                    renderPortfolio();
                }
            } catch (e) {
                console.error('Portfolio fetch error:', e);
            }
        }

        function renderPortfolio() {
            const body = document.getElementById('portfolioBody');
            const filtered = portfolioData.filter(h => h.type === currentPortfolioTab);

            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="6" style="padding: 3rem; text-align: center; color: var(--text-secondary);">No ${currentPortfolioTab.toLowerCase()}s found.</td></tr>`;
                return;
            }

            body.innerHTML = filtered.map(h => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 1rem;">
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-weight: 800; color: var(--accent-primary); cursor: pointer;" onclick="analyzeStockFromPortfolio('${h.ticker}')">${h.ticker.replace(/\.(BO|NS)$/, '')}</span>
                            <span style="font-size: 0.7rem; color: var(--text-muted);">${h.type.toUpperCase()}</span>
                        </div>
                    </td>
                    <td style="padding: 1rem; font-weight: 700;">${h.quantity}</td>
                    <td style="padding: 1rem; font-family: monospace;">â‚¹${h.avg_price.toFixed(2)}</td>
                    <td style="padding: 1rem; font-family: monospace;">â‚¹${h.current_price.toFixed(2)}</td>
                    <td style="padding: 1rem; font-weight: 700;">â‚¹${(h.quantity * h.avg_price).toLocaleString()}</td>
                    <td style="padding: 1rem; text-align: center; display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.7rem; background: var(--bg-glass); color: var(--text-primary);" onclick="analyzeStockFromPortfolio('${h.ticker}')">
                            <i class="fas fa-chart-line"></i> ANALYZE
                        </button>
                        <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.7rem; background: rgba(239, 68, 68, 0.1); color: var(--accent-danger); border: 1px solid rgba(239, 68, 68, 0.2);" onclick="removeFromPortfolio('${h.ticker}', '${h.type}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function analyzeStockFromPortfolio(ticker) {
            document.getElementById('tickerInput').value = ticker;
            showView('dashboard');
            analyzeStock();
        }

        async function removeFromPortfolio(ticker, type) {
            if (!confirm(`Are you sure you want to remove ${ticker} ${type} from your portfolio?`)) return;

            try {
                const response = await fetch('/api/portfolio', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, type })
                });
                const result = await response.json();
                if (result.success) {
                    fetchPortfolio(); // Refresh
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                console.error('Portfolio remove error:', e);
            }
        }

        async function fetchOptionChain() {
            const symbol = document.getElementById('optionSymbol').value;
            const expirySelect = document.getElementById('optionExpiry');
            const targetExpiry = expirySelect.value;
            const greeksBody = document.getElementById('upstoxGreeksBody');
            const fullBody = document.getElementById('fullChainBody');
            const optCard = document.getElementById('optionInsightsCard');
            const optError = document.getElementById('optError');
            const mostActiveEl = document.getElementById('mostActiveStrike');
            const leastActiveEl = document.getElementById('leastActiveStrike');
            const oiChartCard = document.getElementById('optionChartCard');
            let oiChartInstance = null;

            if (document.getElementById('optIndexName')) {
                document.getElementById('optIndexName').textContent = symbol;
            }

            if (greeksBody) greeksBody.innerHTML = '<tr><td colspan="3" style="padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            fullBody.innerHTML = '<tr><td colspan="7" style="padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Fetching Full Chain...</td></tr>';
            optError.style.display = 'none';

            try {
                const url = targetExpiry ? `/api/option-chain?symbol=${symbol}&expiry=${targetExpiry}` : `/api/option-chain?symbol=${symbol}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    // 1. Update Movement & Summary Stats
                    if (result.summary) {
                        if (mostActiveEl) mostActiveEl.textContent = result.summary.most_active_strike || '--';
                        if (leastActiveEl) leastActiveEl.textContent = result.summary.least_active_strike || '--';

                        // Update title with chain name
                        if (document.getElementById('fullChainTitle')) {
                            document.getElementById('fullChainTitle').textContent = `Full Option Chain - ${result.summary.chain_name || symbol}`;
                        }

                        // Update summary indicators
                        if (document.getElementById('underlyingValue')) document.getElementById('underlyingValue').textContent = (result.summary.underlying_value !== undefined && result.summary.underlying_value !== null) ? result.summary.underlying_value : '--';
                        if (document.getElementById('upstoxPcr')) document.getElementById('upstoxPcr').textContent = (result.summary.pcr !== undefined && result.summary.pcr !== null) ? result.summary.pcr : '--';
                        if (document.getElementById('upstoxExpiry')) document.getElementById('upstoxExpiry').textContent = result.summary.expiry || '--';
                    }

                    // 2. Render Greeks Table (if Upstox insights exist)
                    if (result.upstox_insights && result.upstox_insights.items) {
                        if (optCard) optCard.style.display = 'block';
                        if (greeksBody) {
                            greeksBody.innerHTML = result.upstox_insights.items.map(item => `
                                <tr>
                                    <td style="padding: 0.75rem; color: var(--accent-success); font-family: monospace;">
                                        ${item.ce_delta.toFixed(2)} | ${item.ce_theta.toFixed(1)} | ${item.ce_gamma.toFixed(3)} | ${item.ce_vega.toFixed(1)}
                                    </td>
                                    <td style="padding: 0.75rem; font-weight: 700; background: rgba(255,255,255,0.03); text-align: center;">${item.strike}</td>
                                    <td style="padding: 0.75rem; color: var(--accent-danger); font-family: monospace;">
                                        ${item.pe_delta.toFixed(2)} | ${item.pe_theta.toFixed(1)} | ${item.pe_gamma.toFixed(3)} | ${item.pe_vega.toFixed(1)}
                                    </td>
                                </tr>
                            `).join('');
                        }
                    } else if (optCard) {
                        optCard.style.display = 'none';
                    }

                    // Render Full Chain Table
                    fullBody.innerHTML = result.data.map(item => {
                        const ceMv = item.CE.movement || 'N/A';
                        const peMv = item.PE.movement || 'N/A';
                        const ceColor = ceMv === 'Bullish' ? 'var(--accent-success)' : (ceMv === 'Bearish' ? 'var(--accent-danger)' : 'var(--text-secondary)');
                        const peColor = peMv === 'Bullish' ? 'var(--accent-success)' : (peMv === 'Bearish' ? 'var(--accent-danger)' : 'var(--text-secondary)');

                        // Activity Highlighting
                        let rowBg = 'transparent';
                        if (result.summary) {
                            if (item.strikePrice == result.summary.most_active_strike) rowBg = 'rgba(16, 185, 129, 0.08)';
                            else if (item.strikePrice == result.summary.least_active_strike) rowBg = 'rgba(239, 68, 68, 0.08)';
                        }

                        return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; background: ${rowBg};" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='${rowBg}'">
                            <td style="padding: 0.75rem; color: ${ceColor}; font-weight: 600;">${ceMv}</td>
                            <td style="padding: 0.75rem; color: var(--text-primary); font-weight: 700; background: rgba(239, 68, 68, 0.02); border-left: 1px solid var(--border-color);">${(item.CE.openInterest || 0).toLocaleString()}</td>
                            <td style="padding: 0.75rem; color: var(--accent-success); font-family: monospace; font-weight: 700;">â‚¹${item.CE.lastPrice || 0}</td>
                            <td style="padding: 0.75rem; font-weight: 800; background: rgba(255,255,255,0.03); color: var(--accent-primary);">${item.strikePrice}</td>
                            <td style="padding: 0.75rem; font-weight: 600; color: var(--text-secondary);">${item.expiry || 'N/A'}</td>
                            <td style="padding: 0.75rem; color: var(--accent-danger); font-family: monospace; font-weight: 700;">â‚¹${item.PE.lastPrice || 0}</td>
                            <td style="padding: 0.75rem; color: var(--text-primary); font-weight: 700; background: rgba(16, 185, 129, 0.02); border-right: 1px solid var(--border-color);">${(item.PE.openInterest || 0).toLocaleString()}</td>
                            <td style="padding: 0.75rem; color: ${peColor}; font-weight: 600;">${peMv}</td>
                        </tr>
                    `}).join('');

                    // 3. Render OI Chart
                    if (oiChartCard && result.data && result.data.length > 0) {
                        oiChartCard.style.display = 'block';
                        const ctx = document.getElementById('oiChart').getContext('2d');

                        // Clear existing chart if any
                        if (window.myOIChart) window.myOIChart.destroy();

                        const chartData = result.data.slice(0, 30); // Use a subset for clarity
                        const labels = chartData.map(item => item.strikePrice);
                        const ceOI = chartData.map(item => item.CE.openInterest);
                        const peOI = chartData.map(item => item.PE.openInterest);

                        window.myOIChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Call OI',
                                        data: ceOI,
                                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                                        borderColor: '#10b981',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Put OI',
                                        data: peOI,
                                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                        borderColor: '#ef4444',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    x: {
                                        grid: { color: 'rgba(255,255,255,0.05)' },
                                        ticks: { color: 'var(--text-secondary)', font: { size: 10 } }
                                    },
                                    y: {
                                        grid: { color: 'rgba(255,255,255,0.05)' },
                                        ticks: { color: 'var(--text-secondary)', font: { size: 10 } }
                                    }
                                }
                            }
                        });
                    }

                    // 4. Update Expiry Dropdown if not already set or if symbol changed
                    if (result.all_expiries && result.all_expiries.length > 0) {
                        const currentValue = expirySelect.value;
                        // Only rebuild if the dropdown only has the default option or if we forced a refresh
                        if (expirySelect.options.length <= 1 || result.all_expiries.indexOf(currentValue) === -1) {
                            expirySelect.innerHTML = '<option value="">Nearest Expiry</option>';
                            result.all_expiries.forEach(exp => {
                                const opt = document.createElement('option');
                                opt.value = exp;
                                opt.textContent = exp;
                                if (exp === result.summary.expiry) opt.selected = true;
                                expirySelect.appendChild(opt);
                            });
                        }
                    }

                } else {
                    optError.textContent = result.error || "Failed to load option chain data.";
                    optError.style.display = 'block';
                    fullBody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; color: var(--text-secondary);">No data loaded</td></tr>';
                }
            } catch (error) {
                console.error('Option chain fetch error:', error);
                optError.textContent = "Connection error while fetching option chain.";
                optError.style.display = 'block';
                fullBody.innerHTML = '';
            }
        }

        async function fetchMarketIndices() {
            try {
                const response = await fetch('/api/market/indices');
                const result = await response.json();

                if (result.success && result.indices) {
                    const container = document.getElementById('indicesTicker');
                    const itemsHtml = result.indices.map(idx => `
                        <div class="index-item">
                            <span class="index-name">${idx.name}</span>
                            <span class="index-value">â‚¹${idx.value.toLocaleString()}</span>
                            <span class="index-change ${idx.change >= 0 ? 'up' : 'down'}">
                                ${idx.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(idx.change)}%
                            </span>
                        </div>
                    `).join('');

                    // Duplicate items for seamless loop
                    container.innerHTML = itemsHtml + itemsHtml;
                }
            } catch (error) {
                console.error('Error fetching indices:', error);
            }
        }

        // Auto-focus on input
        document.getElementById('tickerInput').focus();

        // --- THEME MANAGEMENT ---
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('themeIcon');
            if (theme === 'dark') {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
            localStorage.setItem('theme', theme);

            // Reload chart with new theme if a ticker is active
            if (currentTicker) {
                loadChart(currentTicker, currentTimeframe);
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const next = current === 'light' ? 'dark' : 'light';
            applyTheme(next);
        }

        // Initialize theme on load
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);


        async function updateMarketStatus() {
            try {
                const response = await fetch('/api/market/status');
                const result = await response.json();

                const statusText = document.getElementById('marketStatusText');
                const statusDot = document.getElementById('marketStatusDot');

                if (result.success) {
                    const status = result.status; // OPEN, CLOSED, PRE-OPEN, etc.
                    statusText.textContent = `MARKET ${status}`;

                    if (status === 'OPEN') {
                        statusDot.style.background = 'var(--accent-success)';
                        statusDot.style.boxShadow = '0 0 10px var(--accent-success)';
                    } else {
                        statusDot.style.background = 'var(--accent-danger)';
                        statusDot.style.boxShadow = 'none';
                        statusDot.style.animation = 'none'; // Stop pulsing if closed
                    }
                }
            } catch (error) {
                console.error('Error updating market status:', error);
            }
        }

        // Initial fetches
        fetchMarketIndices();
        setInterval(fetchMarketIndices, 30000); // Update every 30s
        updateMarketStatus();
        setInterval(updateMarketStatus, 60000); // Update every 1 minute

    </script>

</body>

</html>
```